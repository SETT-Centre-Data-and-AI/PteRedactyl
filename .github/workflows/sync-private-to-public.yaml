name: Sync Private to Public

on:
  # Trigger when PR closed
  pull_request:
    types: [closed]
    branches:
    - main

  # Allow Manual Trigger
  workflow_dispatch: {}

env:
  PRIVATE_REPO: SETT-Centre-Data-and-AI/PteRedactyl_development
  PRIVATE_REPO_RELEASE_BRANCH: main
  PUBLIC_REPO: SETT-Centre-Data-and-AI/PteRedactyl
  PUBLIC_REPO_INCOMING_BRANCH: incoming_from_private
  PRIVATE_GH_TOKEN: ${{ secrets.PUBLIC_REPO_PAT }}

jobs:
  sync-to-public:
    if: ${{ github.repository == env.PRIVATE_REPO && ( github.event_name == 'workflow_dispatch' || github.event.pull_request.merged == true ) }}

    runs-on: ubuntu-latest

    steps:

    # 1. Checkout
    - name: Checkout private release branch
      uses: actions/checkout@v4
      with:
        ref: ${{ env.PRIVATE_REPO_RELEASE_BRANCH }}
        fetch-depth: 0
        persist-credentials: false

    # 2. Check PAT is available
    - name: Check PAT is available
      run: |
        if [ -z "${{ env.PRIVATE_GH_TOKEN }}" ]; then
          echo "ERROR: PRIVATE_GH_TOKEN is not set or empty"
          exit 1
        else
          echo "PRIVATE_GH_TOKEN is set (value hidden)"
        fi

    # 4. Configure public remote, check if incoming branch exists, and check for existing PR
    - name: Check public repo for branch and PR
      env:
        PRIVATE_GH_TOKEN: ${{ env.PRIVATE_GH_TOKEN }}
        PUBLIC_REPO: ${{ env.PUBLIC_REPO }}
        PUBLIC_REPO_INCOMING_BRANCH: ${{ env.PUBLIC_REPO_INCOMING_BRANCH }}
        PRIVATE_REPO_RELEASE_BRANCH: ${{ env.PRIVATE_REPO_RELEASE_BRANCH }}
      run: |
        # Make sure no GitHub extraheader (with GITHUB_TOKEN) overrides our PAT
        git config --unset-all http.https://github.com/.extraheader || true

        # Ensure remote 'public' is configured
        git remote remove public 2>/dev/null || true
        git remote add public https://x-access-token:${PRIVATE_GH_TOKEN}@github.com/${PUBLIC_REPO}.git

        echo "Checking if branch ${PUBLIC_REPO_INCOMING_BRANCH} exists on public..."
        branch_ref=$(git ls-remote --heads public "refs/heads/${PUBLIC_REPO_INCOMING_BRANCH}" || true)
        if [ -n "$branch_ref" ]; then
          echo "Public branch ${PUBLIC_REPO_INCOMING_BRANCH} already exists."
          echo "PUBLIC_BRANCH_EXISTS=true" >> "$GITHUB_ENV"
        else
          echo "Public branch ${PUBLIC_REPO_INCOMING_BRANCH} does not exist yet."
          echo "PUBLIC_BRANCH_EXISTS=false" >> "$GITHUB_ENV"
        fi

        echo "Checking for existing open PR from ${PUBLIC_REPO_INCOMING_BRANCH} to ${PRIVATE_REPO_RELEASE_BRANCH} on ${PUBLIC_REPO}..."
        export GH_TOKEN="$PRIVATE_GH_TOKEN"
        existing_pr=$(gh pr list \
          --repo "$PUBLIC_REPO" \
          --head "${PUBLIC_REPO_INCOMING_BRANCH}" \
          --base "${PRIVATE_REPO_RELEASE_BRANCH}" \
          --state open \
          --json number \
          --jq '.[0].number' || true)

        if [ -n "$existing_pr" ]; then
          echo "Found existing PR #$existing_pr."
        else
          echo "No existing open PR."
        fi

        echo "EXISTING_PR=$existing_pr" >> "$GITHUB_ENV"

    # 5. Push to public incoming branch
    - name: Push private release branch to public incoming branch
      env:
        PRIVATE_GH_TOKEN: ${{ env.PRIVATE_GH_TOKEN }}
        PUBLIC_REPO: ${{ env.PUBLIC_REPO }}
        PUBLIC_REPO_INCOMING_BRANCH: ${{ env.PUBLIC_REPO_INCOMING_BRANCH }}
      run: |
        # Remote 'public' already added in previous step, but ensure it exists
        git remote show public >/dev/null 2>&1 || git remote add public https://x-access-token:${PRIVATE_GH_TOKEN}@github.com/${PUBLIC_REPO}.git

        echo "Pushing HEAD to public:${PUBLIC_REPO_INCOMING_BRANCH}..."
        git push public HEAD:refs/heads/${PUBLIC_REPO_INCOMING_BRANCH} --force

    # 6. Create PR if needed
    - name: Create PR on public repo if needed
      env:
        GH_TOKEN: ${{ env.PRIVATE_GH_TOKEN }}
        PUBLIC_REPO: ${{ env.PUBLIC_REPO }}
        PUBLIC_REPO_INCOMING_BRANCH: ${{ env.PUBLIC_REPO_INCOMING_BRANCH }}
        PRIVATE_REPO_RELEASE_BRANCH: ${{ env.PRIVATE_REPO_RELEASE_BRANCH }}
      run: |
        # EXISTING_PR (if set) comes from the previous step via GITHUB_ENV
        echo "Existing PR: ${EXISTING_PR:-<none>}"

        if [ -n "${EXISTING_PR:-}" ]; then
          echo "Skipping PR creation because PR #$EXISTING_PR already exists."
          exit 0
        fi

        echo "Creating PR from ${PUBLIC_REPO_INCOMING_BRANCH} to ${PRIVATE_REPO_RELEASE_BRANCH} on ${PUBLIC_REPO}..."
        gh pr create \
          --repo "$PUBLIC_REPO" \
          --head "${PUBLIC_REPO_INCOMING_BRANCH}" \
          --base "${PRIVATE_REPO_RELEASE_BRANCH}" \
          --title "Sync from private ${PRIVATE_REPO_RELEASE_BRANCH}" \
          --body "Automated sync of private ${PRIVATE_REPO_RELEASE_BRANCH} to public repo."
