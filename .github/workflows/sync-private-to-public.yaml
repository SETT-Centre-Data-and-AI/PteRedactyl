name: Sync Private to Public

on:
  # Trigger when PR closed
  pull_request:
    types: [closed]
    branches:
    - main

  # Allow Manual Trigger
  workflow_dispatch: {}

jobs:
  sync-to-public:
    # Run if private repo and PR merged or manually triggered
    if: |
      github.repository == 'SETT-Centre-Data-and-AI/PteRedactyl_development' &&
      (
        github.event_name == 'workflow_dispatch' ||
        github.event.pull_request.merged == true
      )

    runs-on: ubuntu-latest

    steps:
    - name: Checkout private main
      uses: actions/checkout@v4
      with:
        ref: main
        fetch-depth: 0
        persist-credentials: false

    - name: Check PAT is available
      env:
        PUBLIC_REPO_PAT: ${{ secrets.PUBLIC_REPO_PAT }}
      run: |
        if [ -z "$PUBLIC_REPO_PAT" ]; then
          echo "ERROR: PUBLIC_REPO_PAT is not set or empty"
          exit 1
        else
          echo "PUBLIC_REPO_PAT is set (value hidden)"
        fi

    - name: Push to public incoming_from_private
      env:
        PUBLIC_REPO_PAT: ${{ secrets.PUBLIC_REPO_PAT }}
      run: |
        git config --unset-all http.https://github.com/.extraheader || true
        git remote add public https://x-access-token:${PUBLIC_REPO_PAT}@github.com/SETT-Centre-Data-and-AI/PteRedactyl.git
        # Force-update incoming_from_private on the public repo from private main
        git push public HEAD:refs/heads/incoming_from_private --force

    - name: Create or reuse PR on public repo (incoming_from_private â†’ main)
      env:
        GH_TOKEN: ${{ secrets.PUBLIC_REPO_PAT }}
      run: |
        # Authenticate gh with the PAT that has access to the public repo
        gh auth login --with-token <<< "$GH_TOKEN"
        gh repo set-default SETT-Centre-Data-and-AI/PteRedactyl

        # Check if an open PR already exists from incoming_from_private to main
        existing_pr=$(gh pr list --head incoming_from_private --base main --state open --json number --jq '.[0].number')

        if [ -z "$existing_pr" ]; then
          gh pr create \
            --head incoming_from_private \
            --base main \
            --title "Sync from private main" \
            --body "Automated sync of private main to public repo."
        else
          echo "Open PR #$existing_pr already exists from incoming_from_private to main on public repo."
        fi
